---
// LinkForm.astro
---
<!-- Form -->
    <form class="lf-form" id="linkForm" novalidate>
      <!-- URL Field -->
      <div class="lf-field-group">
        <label class="lf-label" for="lf-url">
          <span class="lf-label-line"></span>
          url original
        </label>
        <div class="lf-input-wrapper" id="wrapper-url">
          <span class="lf-prefix">https://</span>
          <input
            id="lf-url"
            name="url"
            type="text"
            placeholder="enlace-a-patito.com/myducks.html"
            autocomplete="off"
            spellcheck="false"
          />
        </div>
      </div>

      <!-- Alias Field -->
      <div class="lf-field-group">
        <label class="lf-label" for="lf-alias">
          <span class="lf-label-line"></span>
          Alias personalizado
          <span class="lf-badge">required</span>
        </label>
        <div class="lf-input-wrapper" id="wrapper-alias">
          <span class="lf-prefix">linksy.io/</span>
          <input
            id="lf-alias"
            name="alias"
            type="text"
            placeholder="patito"
            autocomplete="off"
            spellcheck="false"
          />
        </div>
      </div>

      <!-- Submit -->
      <button type="submit" class="lf-button" id="lf-submit" disabled>
        <span class="lf-button-content" id="lf-btn-content">
          <span class="lf-arrow">→</span>
          crear link
        </span>
      </button>
    </form>

    <!-- Result block (hidden by default) -->
    <div class="lf-result hidden" id="lf-result">
      <div class="lf-result-row">
        <span class="lf-result-label">
          <span class="lf-label-line"></span>
          link generado
        </span>
        <button class="lf-copy-btn" id="lf-copy-btn" title="Copiar enlace">
          <span id="lf-copy-icon">⎘</span>
        </button>
      </div>
      <a id="lf-result-url" href="#" target="_blank" rel="noopener noreferrer"></a>
    </div>

    <!-- Error block (hidden by default) -->
    <div class="lf-error hidden" id="lf-error">
      <span class="lf-label-line"></span>
      <span id="lf-error-msg"></span>
    </div>

    <!-- Footer -->
    <div class="lf-footer">
      <span class="lf-footer-text">Realizado con cariño ❤️</span>
      <div class="lf-footer-dots" aria-hidden="true">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>
</div>

<script>
  import { createLink } from '../lib/api';

  const form       = document.getElementById("linkForm") as HTMLFormElement;
  const urlInput   = document.getElementById("lf-url") as HTMLInputElement;
  const aliasInput = document.getElementById("lf-alias") as HTMLInputElement;
  const submitBtn  = document.getElementById("lf-submit") as HTMLButtonElement;
  const btnContent = document.getElementById("lf-btn-content")!;
  const resultBlock = document.getElementById("lf-result")!;
  const resultUrl   = document.getElementById("lf-result-url") as HTMLAnchorElement;
  const errorBlock  = document.getElementById("lf-error")!;
  const errorMsg    = document.getElementById("lf-error-msg")!;
  const copyBtn     = document.getElementById("lf-copy-btn")!;
  const copyIcon    = document.getElementById("lf-copy-icon")!;

  // ── Focus states ──
  document.querySelectorAll<HTMLInputElement>(".lf-input-wrapper input").forEach((input) => {
    const wrapper = input.closest(".lf-input-wrapper")!;
    input.addEventListener("focus", () => wrapper.classList.add("focused"));
    input.addEventListener("blur",  () => wrapper.classList.remove("focused"));
  });

  // ── Enable/disable button ──
  urlInput.addEventListener("input", () => {
    submitBtn.disabled = urlInput.value.trim() === "";
    hideResult();
    hideError();
  });

  // ── State helpers ──
  function setLoading() {
    submitBtn.disabled = true;
    submitBtn.classList.add("loading");
    btnContent.innerHTML = `
      <span class="lf-dot-1"></span>
      <span class="lf-dot-2"></span>
      <span class="lf-dot-3"></span>
    `;
  }

  function setSuccess() {
    submitBtn.classList.remove("loading");
    submitBtn.classList.add("success");
    btnContent.innerHTML = `<span>✓</span> ENLACE CREADO`;
  }

  function resetButton() {
    submitBtn.classList.remove("loading", "success");
    submitBtn.disabled = false;
    btnContent.innerHTML = `<span class="lf-arrow">→</span> CREAR LINK`;
  }

  function showResult(url: string) {
    resultUrl.href        = url;
    resultUrl.textContent = url;
    resultBlock.classList.remove("hidden");
  }

  function hideResult() {
    resultBlock.classList.add("hidden");
  }

  function showError(message: string) {
    errorMsg.textContent = message;
    errorBlock.classList.remove("hidden");
  }

  function hideError() {
    errorBlock.classList.add("hidden");
  }

  // ── Copy to clipboard ──
  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(resultUrl.href);
      copyIcon.textContent = "✓";
      copyBtn.classList.add("copied");
      setTimeout(() => {
        copyIcon.textContent = "⎘";
        copyBtn.classList.remove("copied");
      }, 2000);
    } catch {
      // Fallback for older browsers
      const tmp = document.createElement("input");
      tmp.value = resultUrl.href;
      document.body.appendChild(tmp);
      tmp.select();
      document.execCommand("copy");
      document.body.removeChild(tmp);
    }
  });

  // ── Submit ──
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const url   = urlInput.value.trim();
    const alias = aliasInput.value.trim();

    if (!url) return;

    hideResult();
    hideError();
    setLoading();

    const result = await createLink(url, alias);

    if ("error" in result) {
      const errorText = Array.isArray(result.error)
        ? result.error.map((e) => e.message).join(" · ")
        : result.error;

      resetButton();
      showError(errorText);
      return;
    }

    // Success
    setSuccess();
    showResult(result.shortUrl);
    form.reset();
    submitBtn.disabled = true;

    setTimeout(resetButton, 3000);
  });
</script>

